# 📖 TrainSQL 语法参考手册

> 本文档详细介绍 TrainSQL 支持的所有 SQL 语法和使用示例

---

## 目录

- [1. CREATE / DROP TABLE](#1-create--drop-table)
- [2. INSERT](#2-insert)
- [3. SELECT](#3-select)
- [4. UPDATE](#4-update)
- [5. DELETE](#5-delete)
- [6. SHOW](#6-show)
- [7. TRANSACTION](#7-transaction)
- [8. EXPLAIN](#8-explain)
  
---

## 1. CREATE / DROP TABLE

### 创建表

**语法**：
```sql
CREATE TABLE table_name (
    column_name data_type [INDEX] [column_constraint ...]
    [, ...]
);
```

#### 支持的数据类型

| 类型 | 别名 | 说明 |
|:-----|:-----|:-----|
| `BOOLEAN` | `BOOL` | 布尔值: `true` / `false` |
| `INTEGER` | `INT` | 整数 |
| `FLOAT` | `DOUBLE` | 浮点数 |
| `STRING` | `TEXT`, `VARCHAR`, `CHAR` | 字符串 |

#### 支持的列约束

| 约束 | 说明 |
|:-----|:-----|
| `PRIMARY KEY` | 主键 (唯一且非空) |
| `INDEX` | 二级索引 |
| `NOT NULL` | 非空约束 |
| `NULL` | 允许为空 (默认) |
| `DEFAULT expr` | 默认值 |

**示例**：
```sql
-- 创建一个包含多种数据类型的表
CREATE TABLE t2 (
    a INT PRIMARY KEY,
    b INTEGER DEFAULT 100,
    c FLOAT DEFAULT 1.1,
    d BOOL DEFAULT false,
    e BOOLEAN DEFAULT true,
    f TEXT DEFAULT 'v1',
    g STRING DEFAULT 'v2',
    h VARCHAR DEFAULT 'v3'
);

-- 创建带索引的表
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR NOT NULL,
    age INT INDEX DEFAULT 0
);
```

### 删除表

**语法**：
```sql
DROP TABLE table_name;
```

**示例**：
```sql
DROP TABLE t2;
```

---

## 2. INSERT

**语法**：
```sql
-- 指定所有列
INSERT INTO table_name VALUES (expr [, ...]);

-- 指定部分列
INSERT INTO table_name (column_name [, ...]) VALUES (expr [, ...]);

-- 批量插入
INSERT INTO table_name VALUES (expr, ...), (expr, ...), ...;
```

**示例**：
```sql
-- 插入单行 (所有列)
INSERT INTO t2 VALUES (1, 2, 3.0, true, false, 'v1', 'v2', 'v3');

-- 插入单行 (指定列)
INSERT INTO users (id, name) VALUES (1, 'Alice');

-- 批量插入
INSERT INTO users VALUES (2, 'Bob', 25), (3, 'Carol', 30);
```

---

## 3. SELECT

**语法**：
```sql
SELECT [ * | column_name | aggregate_function [[AS] alias] [, ...] ]
FROM from_item
[WHERE condition]
[GROUP BY column_name]
[HAVING condition]
[ORDER BY column_name [ASC | DESC] [, ...]]
[LIMIT count]
[OFFSET count]
```

### 基础查询

```sql
-- 查询所有列
SELECT * FROM t2;

-- 查询指定列
SELECT a, b FROM t2;

-- 带别名
SELECT a AS id, b AS value FROM t2;
```

### 条件查询 (WHERE)

```sql
SELECT * FROM t2 WHERE a = 1;
SELECT * FROM t2 WHERE a > 10;
SELECT * FROM t2 WHERE a < 100;
```

### 排序 (ORDER BY)

```sql
-- 升序 (默认)
SELECT * FROM t2 ORDER BY a;
SELECT * FROM t2 ORDER BY a ASC;

-- 降序
SELECT * FROM t2 ORDER BY a DESC;

-- 多列排序
SELECT * FROM t2 ORDER BY a DESC, b ASC;
```

### 分页 (LIMIT / OFFSET)

```sql
-- 取前 10 条
SELECT * FROM t2 LIMIT 10;

-- 跳过前 5 条，取 10 条
SELECT * FROM t2 LIMIT 10 OFFSET 5;
```

### 聚合函数

| 函数 | 说明 |
|:-----|:-----|
| `COUNT(col)` | 统计行数 (排除 NULL) |
| `SUM(col)` | 求和 |
| `AVG(col)` | 求平均值 |
| `MAX(col)` | 最大值 |
| `MIN(col)` | 最小值 |

```sql
-- 聚合查询
SELECT COUNT(a) AS total, MAX(b), MIN(a), SUM(c), AVG(c) FROM t2;
```

### 分组 (GROUP BY / HAVING)

```sql
-- 按列分组
SELECT a, COUNT(b) FROM t2 GROUP BY a;

-- 分组 + 过滤
SELECT a, COUNT(b) FROM t2 GROUP BY a HAVING COUNT(b) > 1;

-- 分组 + 排序 + 分页
SELECT a, COUNT(b) FROM t2 
  GROUP BY a 
  ORDER BY a DESC 
  LIMIT 1 OFFSET 2;
```

### 多表连接 (JOIN)

#### 支持的连接类型

| 连接类型 | 说明 |
|:---------|:-----|
| `JOIN` / `INNER JOIN` | 内连接，返回两表匹配的行 |
| `LEFT JOIN` | 左连接，返回左表所有行 + 右表匹配行 |
| `RIGHT JOIN` | 右连接，返回右表所有行 + 左表匹配行 |
| `CROSS JOIN` | 交叉连接，笛卡尔积 |

**语法**：
```sql
SELECT * FROM table1 
  join_type table2 ON condition
  [join_type table3 ON condition ...]
```

**示例**：
```sql
-- 内连接
SELECT * FROM haj1 JOIN haj2 ON a = b;

-- 左连接
SELECT * FROM haj1 LEFT JOIN haj2 ON a = b;

-- 右连接
SELECT * FROM haj1 RIGHT JOIN haj2 ON a = b;

-- 多表连接
SELECT * FROM haj1 
  JOIN haj2 ON a = b 
  JOIN haj3 ON a = c;
```

---

## 4. UPDATE

**语法**：
```sql
UPDATE table_name
SET column_name = expr [, ...]
[WHERE condition];
```

**示例**：
```sql
-- 更新所有行
UPDATE t2 SET b = 100;

-- 条件更新
UPDATE t2 SET a = 10 WHERE a < 11;
UPDATE t2 SET b = 70 WHERE a > 11;

-- 更新多列
UPDATE t2 SET b = 50, c = 3.14 WHERE a = 1;
```

---

## 5. DELETE

**语法**：
```sql
DELETE FROM table_name
[WHERE condition];
```

**示例**：
```sql
-- 删除所有行 (谨慎!)
DELETE FROM t2;

-- 条件删除
DELETE FROM t2 WHERE a < 11;
DELETE FROM t2 WHERE a > 11;
DELETE FROM t2 WHERE a = 11;
```

---

## 6. SHOW

### 查看所有表

**语法**：
```sql
SHOW TABLES;
```

**示例**：
```sql
SHOW TABLES;
```

**输出**：
```
t1,t2,t3,t4,test4,test5,test6
```

### 查看表结构

**语法**：
```sql
SHOW TABLE table_name;
```

**示例**：
```sql
SHOW TABLE t2;
```

**输出**：
```
COLUMNS: { 
    a Integer PRIMARY KEY
    b Integer DEFAULT 100
    c Float DEFAULT 1.1
    d Boolean DEFAULT false
    e Boolean DEFAULT true
    f String DEFAULT v1
    g String DEFAULT v2
    h String DEFAULT v3
}
```

---

## 7. Transaction

> TrainSQL 支持事务操作，提供 MVCC 多版本并发控制

### 事务命令

| 命令 | 说明 |
|:-----|:-----|
| `BEGIN` | 开始事务 |
| `COMMIT` | 提交事务 |
| `ROLLBACK` | 回滚事务 |

**示例**：
```sql
-- 开始事务
BEGIN;
-- 输出: TRANSACTION 136 BEGIN

-- 执行操作
INSERT INTO t2 VALUES (100, 200, 3.0, true, false, 'a', 'b', 'c');
UPDATE t2 SET b = 999 WHERE a = 100;

-- 提交事务
COMMIT;
-- 输出: TRANSACTION 136 COMMIT
```

```sql
-- 回滚示例
BEGIN;
DELETE FROM t2 WHERE a = 1;  -- 删除数据
ROLLBACK;                     -- 撤销删除
-- 输出: TRANSACTION 137 ROLLBACK
```

---

## 8. EXPLAIN

> 查看 SQL 语句的执行计划，用于性能分析和优化

**语法**：
```sql
EXPLAIN sql_statement;
```

**示例**：
```sql
EXPLAIN SELECT * FROM haj1 JOIN haj2 ON a = b JOIN haj3 ON a = c;
```

**输出**：
```
           SQL PLAN           
------------------------------
 Hash Join (a = c)
  ->   Hash Join (a = b)
     ->  Seq Scan on  haj1
     ->  Seq Scan on  haj2
  ->  Seq Scan on  haj3
```

### 执行计划节点说明

| 节点 | 说明 |
|:-----|:-----|
| `Seq Scan` | 全表扫描 |
| `Primary Key Scan` | 主键索引扫描 |
| `Index Scan` | 二级索引扫描 |
| `Hash Join` | 哈希连接 |
| `Nested Loop Join` | 嵌套循环连接 |
| `Filter` | 过滤条件 |
| `Projection` | 列投影 |
| `Aggregate` | 聚合运算 |
| `Order By` | 排序 |
| `Limit` | 限制行数 |
| `Offset` | 跳过行数 |

---

## 📝 快速参考

### 关键字一览

```
DDL:   CREATE, DROP, TABLE, PRIMARY KEY, INDEX, DEFAULT, NOT NULL
DML:   SELECT, INSERT, UPDATE, DELETE, FROM, WHERE, SET, INTO, VALUES
JOIN:  JOIN, INNER JOIN, LEFT JOIN, RIGHT JOIN, CROSS JOIN, ON
AGG:   COUNT, SUM, AVG, MAX, MIN, GROUP BY, HAVING
SORT:  ORDER BY, ASC, DESC, LIMIT, OFFSET
TXN:   BEGIN, COMMIT, ROLLBACK
OTHER: SHOW, TABLE, DATABASE, EXPLAIN, AS
```
